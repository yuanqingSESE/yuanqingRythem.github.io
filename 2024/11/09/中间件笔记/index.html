<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>
        蒙园青Rythem的博客
    </title>
    
<link rel="stylesheet" href="/libs/highlight/styles/monokai-sublime.css">

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body id="bodyx">
    <div class="hd posts">
    <a href="/index.html"><i class="fa fa-reply replay-btn" aria-hidden="true"></i></a>
    <div class="post-title">
        <p>
            Android中间件笔记
        </p>
        <hr>
    </div>
    <div class="post-content">
        <h1 id="C-HAL层开发"><a href="#C-HAL层开发" class="headerlink" title="C++HAL层开发"></a>C++HAL层开发</h1><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Event</span> : <span class="keyword">public</span> AgwEvent&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Event</span>(::android::sp&lt;InfraStructureHal&gt; infra):<span class="built_in">mInfra</span>(infra) &#123;&#125;</span><br><span class="line">    <span class="comment">// 这行代码的意思其实就是 mInfra = infra;</span></span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Event</span>() &#123;&#125;;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onEventChanged</span><span class="params">(<span class="type">const</span> target&amp; name, <span class="type">const</span> std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; payload)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="built_in">ALOGI</span>(<span class="string">&quot;onEventChanged group name:%s, event name:%s&quot;</span>, name.first.<span class="built_in">c_str</span>(), name.second.<span class="built_in">c_str</span>());</span><br><span class="line">        mInfra-&gt;<span class="built_in">parseData</span>(name, payload);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    ::android::sp&lt;InfraStructureHal&gt; mInfra;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>把编译好的C++bin文件推到车机目录bin文件中会导致车机起不来，应该推到system&#x2F;bin文件中</p>
<p>华人项目编译对应的.hal文件会生成一系列头文件在该目录下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apps/LINUX/android/out/soong/.intermediates/vendor/hht/common/OpenAPIManager/infrastructurehal/hidl</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">arm64/system/lib64$ adb push libinfrastructurehal.so system/lib64/</span><br><span class="line">arm64/lib64$ adb push vendor.hht.infrastructurehal.infrastructurehal@<span class="number">1.0</span>.so system/system_ext/lib64/</span><br><span class="line">./system/system_ext/lib/vendor.hht.infrastructurehal.infrastructurehal@<span class="number">1.0</span>.so</span><br><span class="line">./system/system_ext/lib64/vendor.hht.infrastructurehal.infrastructurehal@<span class="number">1.0</span>.so</span><br><span class="line">推这四个so库</span><br><span class="line">./system/system_ext/lib/vendor.hht.infrastructurehal.infrastructurehal@<span class="number">1.0</span>.so</span><br><span class="line">./system/system_ext/lib64/vendor.hht.infrastructurehal.infrastructurehal@<span class="number">1.0</span>.so</span><br><span class="line">./system/lib/libinfrastructurehal.so</span><br><span class="line">./system/lib64/libinfrastructurehal.so</span><br></pre></td></tr></table></figure>

<h2 id="编译全部APK对应mk是："><a href="#编译全部APK对应mk是：" class="headerlink" title="编译全部APK对应mk是："></a>编译全部APK对应mk是：</h2><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http://10.18.32.32:8080/plugins/gitiles/aosp/platform/build/+/refs/heads/vx1_fsem_dev/target/product/core_minimal.mk</span></span><br><span class="line"><span class="section">http://10.18.32.32:8080/plugins/gitiles/aosp/device/hht/gin/+/refs/heads/vx1_fsem_dev/gin.mk</span></span><br></pre></td></tr></table></figure>

<h2 id="需求如下：需要将2-6位映射到长度为四十位的list里"><a href="#需求如下：需要将2-6位映射到长度为四十位的list里" class="headerlink" title="需求如下：需要将2-6位映射到长度为四十位的list里"></a>需求如下：需要将2-6位映射到长度为四十位的list里</h2><p>data[0]&lt;&lt;8 | data[1] &#x3D; msg_id(ALM_MEMORY_ST)</p>
<p>data[2] &#x3D; ALM1~8StsRsp (bit0 表示资源1， 依次排开， bit7表示资源8) （0 表示未下载， 1表示已下载）</p>
<p>data[3] &#x3D; ALM9~16StsRsp (bit0 表示资源9， 依次排开， bit7表示资源16) （0 表示未下载， 1表示已下载）</p>
<p>data[4] &#x3D; ALM17~24StsRsp (bit0 表示资源17， 依次排开， bit7表示资源24) （0 表示未下载， 1表示已下载）</p>
<p>data[5] &#x3D; ALM25~32StsRsp (bit0 表示资源25， 依次排开， bit7表示资源32) （0 表示未下载， 1表示已下载）</p>
<p>data[6] &#x3D; ALM33~40StsRsp (bit0 表示资源33， 依次排开， bit7表示资源40) （0 表示未下载， 1表示已下载）</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (data.<span class="built_in">size</span>() &gt;= <span class="number">7</span>) &#123;</span><br><span class="line">    <span class="function">hidl_vec&lt;<span class="type">uint8_t</span>&gt; <span class="title">st</span><span class="params">(<span class="number">40</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">uint32_t</span> i = <span class="number">2</span>; i &lt; <span class="number">7</span>; i++)&#123;</span><br><span class="line">        <span class="type">uint32_t</span> m = (i<span class="number">-2</span>)*<span class="number">8</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">uint32_t</span> j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++)&#123;</span><br><span class="line">            st[m+j] = data[i]&gt;&gt;j &amp; <span class="number">0x01</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mService-&gt;<span class="built_in">async</span>([<span class="keyword">this</span>, st] &#123;</span><br><span class="line">        mService-&gt;<span class="built_in">onALMDownloadStatus</span>(st);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">例如</span><br><span class="line">    </span><br><span class="line">data[<span class="number">2</span>] = <span class="number">129</span></span><br><span class="line">st[<span class="number">0</span>] = <span class="number">1</span>, st[<span class="number">1</span>] = <span class="number">0</span>, st[<span class="number">2</span>] = <span class="number">0</span>, st[<span class="number">3</span>] = <span class="number">0</span>, st[<span class="number">4</span>] = <span class="number">0</span>, st[<span class="number">5</span>] = <span class="number">0</span>, st[<span class="number">6</span>] = <span class="number">0</span>, st[<span class="number">7</span>] = <span class="number">1.</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">需要串口板进行输入命令调试的，可以ssh到QNX，在QNX下直接执行命令，不需要经过串口</span><br><span class="line">ssh root@<span class="number">223.255</span><span class="number">.255</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>

<h2 id="将int类型强转uint8-t"><a href="#将int类型强转uint8-t" class="headerlink" title="将int类型强转uint8_t"></a>将int类型强转uint8_t</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> 类型是<span class="number">4</span>个字节（byte）也就是<span class="number">32</span>bit 也就是<span class="number">2</span>^<span class="number">32</span> = <span class="type">uint32_t</span></span><br><span class="line"><span class="type">uint8_t</span> 是<span class="number">2</span>个字节（byte）也就是<span class="number">8</span>bit 也就是<span class="number">2</span>^<span class="number">8</span></span><br><span class="line">(<span class="type">uint8_t</span>)crc32;转化其实就是将crc32%<span class="number">256</span> = <span class="type">uint8_t</span>类型的crc32</span><br></pre></td></tr></table></figure>

<h2 id="C-多线程"><a href="#C-多线程" class="headerlink" title="C++多线程"></a>C++多线程</h2><p>不断在main函数中调用两次reconByTime函数会出现什么问题<br>根据代码得知，调用两次reconByTime会开辟两个线程如果某一个线程执行的快直接将mIsHasReponse线程中的变量更改为false直return，第二个线程还在执行中发现变量为false继续循环，就会导致看似第一线程接着第二个线程倒计时，实际上，第一个线程的变量被抢占返回，第二个线程一直在执行。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">reconByTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::thread <span class="title">timeThread</span><span class="params">(&amp;timeOutForALM)</span></span>;</span><br><span class="line">    timeThread.<span class="built_in">join</span>();</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">3000</span>));</span><br><span class="line">    mIsHasReponse = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">timeOutForALM</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> count = <span class="number">8</span>;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;count  &quot;</span> &lt;&lt; count &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">while</span>(count &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        count--;</span><br><span class="line">        <span class="keyword">if</span> (mIsHasReponse) &#123;</span><br><span class="line">            mIsHasReponse = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;SLEEP_MINI_SEC = &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;SLEEP_MINI_SEC = &quot;</span> &lt;&lt; SLEEP_MINI_SEC &lt;&lt; <span class="string">&quot;count&quot;</span> &lt;&lt; count &lt;&lt; std::endl;</span><br><span class="line">        std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(SLEEP_MINI_SEC));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;counter = &quot;</span> &lt;&lt; counter &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Crash经验积累"><a href="#Crash经验积累" class="headerlink" title="Crash经验积累"></a>Crash经验积累</h2><p>kmsg可以看到init进程拉起服务的log</p>
<p>init 进程号是0 进程名为init</p>
<p>addr2line的具体操作，需要根据墓碑找到对应的FTP地址下载symbol，执行以下命令：</p>
<p>其中-e跟报错的so库空格后跟地址，-f -a -C为必要参数</p>
<p>addr2line -e system&#x2F;lib64&#x2F;<a target="_blank" rel="noopener" href="http://libinfrastructurehal.so/">libinfrastructurehal.so</a> 04fa4 -f -a -C</p>
<h2 id="tmd源码编译出现如下错误："><a href="#tmd源码编译出现如下错误：" class="headerlink" title="tmd源码编译出现如下错误："></a>tmd源码编译出现如下错误：</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use of undeclared identifier &#x27;mALMFileNum&#x27;</span><br></pre></td></tr></table></figure>

<p>要核对一下包含该参数的方法是否在某个作用域下，如果在的话需要在方法前写上域</p>
<h2 id="VsCode不能run包含线程的类怎么办："><a href="#VsCode不能run包含线程的类怎么办：" class="headerlink" title="VsCode不能run包含线程的类怎么办："></a>VsCode不能run包含线程的类怎么办：</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">g++ main.cpp -o test -lpthread</span><br><span class="line">./test</span><br></pre></td></tr></table></figure>

<h2 id="Binder发现调用函数与响应函数不是一个？"><a href="#Binder发现调用函数与响应函数不是一个？" class="headerlink" title="Binder发现调用函数与响应函数不是一个？"></a>Binder发现调用函数与响应函数不是一个？</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">从日志中看识别服务只有在05-16 10:44:52的时候由于接收到Fault error然后尝试reinit driver</span><br><span class="line">Line 67792: 05-16 10:44:52.668 1012 1012 I HINFRAStructureHal: Enter[InfraStructureHal:notifyQnxLogCamera]</span><br><span class="line">Line 67795: 05-16 10:44:52.668 1012 1012 I HINFRAStructureHal: [InfraStructureHal:notifyQnxLogCamera] OK! sClient set ret 0</span><br><span class="line">Line 67796: 05-16 10:44:52.669 940 1374 I HINFRAStructureHalAPIC: notifyQnxLogCamera: ret=0</span><br><span class="line">Line 67797: 05-16 10:44:52.669 940 1374 W HHTCameraHAL: [252] notifyQnxLogCamera return 0</span><br><span class="line">Line 67798: 05-16 10:44:52.669 940 1374 E IdentifyService: [275] try reinit driver, send msg to qnx result:0</span><br><span class="line"></span><br><span class="line">但是结合YF的DLT日志分析在07:44:46 Android下发过reinit camera的动作，之后查看StructureHal的日志看到在该时间点的确下发过reinit camera, 结合该接口的前后日志，初步看上去是HSTREAM_sisdDownLoadService 执行该指令</span><br><span class="line">Line 60012: 05-16 07:44:39.866 1479 5148 I HSTREAM_sisdDownLoadService: &lt;&lt;SisdFileSendManager#getCarshowDLStatus:150&gt;&gt; getCarshowDLStatus start!!</span><br><span class="line">Line 60013: 05-16 07:44:39.866 1012 1012 I HINFRAStructureHal: Enter[InfraStructureHal:notifyQnxLogCamera]</span><br><span class="line">Line 60016: 05-16 07:44:39.867 1012 1012 I : [InfraStructureHal:notifyQnxLogCamera] OK! sClient set ret 0</span><br><span class="line">Line 60017: 05-16 07:44:39.867 1479 5148 I HSTREAM_sisdDownLoadService: &lt;&lt;SisdFileSendManager#getCarshowDLStatus:156&gt;&gt; getCarshowDLStatus end ret is 0</span><br><span class="line"></span><br><span class="line">在05-16 10:44:39又出现了一次由HSTREAM_sisdDownLoadService触发reinit camera的动作</span><br><span class="line">Line 65776: 05-16 10:44:39.867 1479 5148 I HSTREAM_sisdDownLoadService: &lt;&lt;SisdFileSendManager#getCarshowDLStatus:150&gt;&gt; getCarshowDLStatus start!!</span><br><span class="line">Line 65777: 05-16 10:44:39.868 1012 1012 I HINFRAStructureHal: Enter[InfraStructureHal:notifyQnxLogCamera]</span><br><span class="line">Line 65780: 05-16 10:44:39.868 1012 1012 I HINFRAStructureHal: [InfraStructureHal:notifyQnxLogCamera] OK! sClient set ret 0</span><br><span class="line">Line 65781: 05-16 10:44:39.869 1479 5148 I HSTREAM_sisdDownLoadService: &lt;&lt;SisdFileSendManager#getCarshowDLStatus:156&gt;&gt; getCarshowDLStatus end ret is 0</span><br></pre></td></tr></table></figure>

<p>解决方案：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">原因：该问题是由于使用旧的静态的InfraStructureOpenAPI库导致的，在binder操作中是通过寻址的操作来进行方法调用的，旧的库getCarshowDLStatus地址对应Service端地址为notifyQnxLogCamera，所以导致了该方法调用</span><br><span class="line"></span><br><span class="line">修改方案：在5月15日已经引用了out目录的静态库，该静态库会实时更新，之前其实是引用了lib里的库，后续版本得到解决。</span><br><span class="line"></span><br><span class="line">11-11 03:35:06.908 1532 4408 I HSTREAM_sisdDownLoadService: &lt;&lt;SisdFileSendManager#getCarshowDLStatus:150&gt;&gt; getCarshowDLStatus start!!</span><br><span class="line">11-11 03:35:06.908 1532 4408 D HINFRAStructureHalAPI: getCarshowDLStatus</span><br><span class="line">11-11 03:35:06.909 1028 1028 I HINFRAStructureHal: Enter[InfraStructureHal:getCarshowDLStatus]</span><br><span class="line">11-11 03:35:06.909 1028 1028 I HINFRAStructureHal: [InfraStructureHal:getCarshowDLStatus] OK! sClient set ret 0</span><br><span class="line">11-11 03:35:06.909 1532 4408 D HINFRAStructureHalAPI: getCarshowDLStatus ret = 0</span><br><span class="line">11-11 03:35:06.910 1532 4408 I HSTREAM_sisdDownLoadService: &lt;&lt;SisdFileSendManager#getCarshowDLStatus:156&gt;&gt; getCarshowDLStatus end ret is 0</span><br></pre></td></tr></table></figure>

<h3 id="后续延伸"><a href="#后续延伸" class="headerlink" title="后续延伸"></a>后续延伸</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH := $(my-dir)</span><br><span class="line"></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(<span class="built_in">wildcard</span> <span class="variable">$(TOP)</span>/vendor/hht/infra/InfraStructureHal/Android.mk)</span>,)</span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line">LOCAL_MODULE := HHTInfraStructureHal</span><br><span class="line">LOCAL_SRC_FILES := \</span><br><span class="line">    <span class="variable">$(TARGET_ARCH)</span>/bin/HHTInfraStructureHal</span><br><span class="line"></span><br><span class="line">LOCAL_C_INCLUDES := \</span><br><span class="line">    <span class="variable">$(LOCAL_PATH)</span>/interface/inc \</span><br><span class="line"></span><br><span class="line">LOCAL_MODULE_CLASS := EXECUTABLES</span><br><span class="line">LOCAL_INIT_RC := init.infrastructurehal.rc</span><br><span class="line">LOCAL_VINTF_FRAGMENTS := vendor.hht.infrastructurehal.infrastructurehal@1.0.xml</span><br><span class="line">LOCAL_REQUIRED_MODULES := \</span><br><span class="line">    vendor.hht.infrastructurehal.infrastructurehal@1.0 \</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(BUILD_PREBUILT)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># update rule</span></span><br><span class="line">private_target := infrastructurehal_binary</span><br><span class="line"></span><br><span class="line"><span class="variable">$(private_target)</span> : PRIVATE_REPOSITORY := vendor/hht/infra/InfraStructureHal</span><br><span class="line"><span class="variable">$(private_target)</span> : INTERFACE_REPOSITORY := vendor/hht/common/OpenAPIManager/infrastructurehal</span><br><span class="line"></span><br><span class="line"><span class="variable">$(private_target)</span> : PRIVATE_COPY_LIST := \</span><br><span class="line">    <span class="variable">$(PRIVATE_REPOSITORY)</span>/service/init.infrastructurehal.rc:<span class="variable">$(LOCAL_PATH)</span>/init.infrastructurehal.rc \</span><br><span class="line">    <span class="variable">$(TARGET_OUT_EXECUTABLES)</span>/HHTInfraStructureHal:<span class="variable">$(LOCAL_PATH)</span>/<span class="variable">$(TARGET_ARCH)</span>/bin/HHTInfraStructureHal \</span><br><span class="line">    <span class="variable">$(TARGET_OUT)</span>/lib/libinfrastructurehal.so:<span class="variable">$(LOCAL_PATH)</span>/<span class="variable">$(TARGET_ARCH)</span>/system/lib/libinfrastructurehal.so \</span><br><span class="line">    <span class="variable">$(TARGET_OUT)</span>/lib64/libinfrastructurehal.so:<span class="variable">$(LOCAL_PATH)</span>/<span class="variable">$(TARGET_ARCH)</span>/system/lib64/libinfrastructurehal.so \</span><br><span class="line">    <span class="variable">$(TARGET_OUT_COMMON_INTERMEDIATES)</span>/JAVA_LIBRARIES/com.hht.opensdk.infrastructurehal_intermediates/classes.jar:<span class="variable">$(LOCAL_PATH)</span>/interface/java/com.hht.opensdk.infrastructurehal.jar \</span><br><span class="line">    <span class="variable">$(TARGET_OUT)</span>/system_ext/lib64/vendor.hht.infrastructurehal.infrastructurehal@1.0.so:<span class="variable">$(LOCAL_PATH)</span>/<span class="variable">$(TARGET_ARCH)</span>/lib64/vendor.hht.infrastructurehal.infrastructurehal@1.0.so \</span><br><span class="line">    <span class="variable">$(TARGET_OUT)</span>/system_ext/lib/vendor.hht.infrastructurehal.infrastructurehal@1.0.so:<span class="variable">$(LOCAL_PATH)</span>/<span class="variable">$(TARGET_ARCH)</span>/lib/vendor.hht.infrastructurehal.infrastructurehal@1.0.so \</span><br><span class="line">    <span class="variable">$(PRIVATE_REPOSITORY)</span>/interface/<span class="keyword">include</span>/InfraStructureHal.h:<span class="variable">$(LOCAL_PATH)</span>/interface/<span class="keyword">include</span>/InfraStructureHal.h \</span><br><span class="line">    <span class="variable">$(SOONG_OUT_DIR)</span>/.intermediates/<span class="variable">$(INTERFACE_REPOSITORY)</span>/hidl/infrastructurehal/1.0/vendor.hht.infrastructurehal.infrastructurehal@1.0_genc++_headers/gen/*:<span class="variable">$(LOCAL_PATH)</span>/interface/inc/</span><br><span class="line"></span><br><span class="line"><span class="variable">$(private_target)</span> : \</span><br><span class="line">    <span class="variable">$(TARGET_OUT_COMMON_INTERMEDIATES)</span>/JAVA_LIBRARIES/com.hht.opensdk.infrastructurehal_intermediates/classes.jar \</span><br><span class="line">    <span class="variable">$(TARGET_OUT)</span>/system_ext/lib64/vendor.hht.infrastructurehal.infrastructurehal@1.0.so \</span><br><span class="line">    <span class="variable">$(TARGET_OUT_EXECUTABLES)</span>/HHTInfraStructureHal \</span><br><span class="line"></span><br><span class="line"><span class="variable">$(private_target)</span> : PRIVATE_CUSTOM_COMMAND := set -ex; \</span><br><span class="line">    <span class="variable">$(<span class="built_in">foreach</span> f, <span class="variable">$(PRIVATE_COPY_LIST)</span>, \</span></span><br><span class="line"><span class="variable">        $(<span class="built_in">eval</span> _cmf_tuple := $(<span class="built_in">subst</span> :, ,<span class="variable">$(f)</span>)</span>) \</span><br><span class="line">        <span class="variable">$(<span class="built_in">eval</span> _cmf_src := $(<span class="built_in">word</span> 1,<span class="variable">$(_cmf_tuple)</span>)</span>) \</span><br><span class="line">        <span class="variable">$(<span class="built_in">eval</span> _cmf_dest := $(<span class="built_in">word</span> 2,<span class="variable">$(_cmf_tuple)</span>)</span>) \</span><br><span class="line">        <span class="variable">$(<span class="built_in">if</span> $(<span class="built_in">filter</span> %/,<span class="variable">$(_cmf_dest)</span>)</span>, mkdir -p <span class="variable">$(_cmf_dest)</span>;, mkdir -p <span class="variable">$(<span class="built_in">dir</span> <span class="variable">$(_cmf_dest)</span>)</span>;) \</span><br><span class="line">        cp -rf <span class="variable">$(_cmf_src)</span> <span class="variable">$(_cmf_dest)</span>;)</span><br><span class="line"></span><br><span class="line"><span class="variable">$(private_target)</span> :</span><br><span class="line">	<span class="variable">$(PRIVATE_CUSTOM_COMMAND)</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: $(private_target)</span></span><br></pre></td></tr></table></figure>

<p>这个文件有什么用呢？<br>在这个mk中会判断当前目录下是否存在</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(<span class="built_in">wildcard</span> <span class="variable">$(TOP)</span>/vendor/hht/infra/InfraStructureHal/Android.mk)</span>,)</span><br></pre></td></tr></table></figure>

<p>如果存在证明什么问题？证明他binary是有中间件具体实现的，也就是infra下是有InfraStructure这个项目的，直接去编InfraStructure就可以了。<br>如果没有的话那么就得走endif下面的mk了。<br>意思就是要把我binary下的so库jar包hidl头文件拷贝到out目录下soong的静态库里，用于只有APP情况下想调用到infra的操作。</p>
<h3 id="char类型转换int"><a href="#char类型转换int" class="headerlink" title="char类型转换int"></a>char类型转换int</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调用C库stdio.h进行转换</span></span><br><span class="line"><span class="type">int</span> num;</span><br><span class="line"><span class="built_in">sscanf</span>(argv[<span class="number">2</span>],<span class="string">&quot;%x&quot;</span>,&amp;num);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%02x&quot;</span>, num);</span><br></pre></td></tr></table></figure>

<h3 id="发现HIDL生成的库我们再引用的时候类型太复杂了想去封装一层该怎么用呢？"><a href="#发现HIDL生成的库我们再引用的时候类型太复杂了想去封装一层该怎么用呢？" class="headerlink" title="发现HIDL生成的库我们再引用的时候类型太复杂了想去封装一层该怎么用呢？"></a>发现HIDL生成的库我们再引用的时候类型太复杂了想去封装一层该怎么用呢？</h3><p>对应路径为：learning-and-work&#x2F;work&#x2F;学习代码&#x2F;InfraStructureHal&#x2F;interface&#x2F;C++</p>
<p>其中interface是接口层，他封装了HIDL生成的很长的返回域名，因为其HIDL可以使用Return&lt;&gt;包裹对应的模版还可以使用Return中的方法比如判断isOk();可以在服务已的情况下调用避免异常抛出。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">operator</span> <span class="built_in">sp</span>&lt;T&gt;() <span class="type">const</span> &#123;</span><br><span class="line">    <span class="built_in">onValueRetrieval</span>();  <span class="comment">// assert okay</span></span><br><span class="line">    <span class="keyword">return</span> mVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应的.h文件在learning-and-work&#x2F;work&#x2F;学习代码&#x2F;InfraStructureHal&#x2F;interface&#x2F;include：</p>
<p>对应的bp文件如下：<br>该文件生成了一个名字为libinfrastructurehal的库，编译了cpp文件和.h文件，需要用到的库有hidl的库工具类以及最重要的InfraStructure编译生成的HIDL接口库，可以给外部C++进行调用，该接口在调用该接口的进程中，他们是同一进程。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cc_library_shared &#123;</span><br><span class="line">    name: <span class="string">&quot;libinfrastructurehal&quot;</span>,</span><br><span class="line">    host_supported: true,</span><br><span class="line">    recovery_available: true,</span><br><span class="line"></span><br><span class="line">    srcs: [</span><br><span class="line">        <span class="string">&quot;C++/InfraStructureHal.cpp&quot;</span>,</span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">    header_libs: [</span><br><span class="line">        <span class="string">&quot;libinfrastructurehal_headers&quot;</span>,</span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">    shared_libs: [</span><br><span class="line">        <span class="string">&quot;liblog&quot;</span>,</span><br><span class="line">        <span class="string">&quot;libutils&quot;</span>,</span><br><span class="line">        <span class="string">&quot;libbase&quot;</span>,</span><br><span class="line">        <span class="string">&quot;libhidlbase&quot;</span>,</span><br><span class="line">        <span class="string">&quot;vendor.hht.infrastructurehal.infrastructurehal@1.0&quot;</span>,</span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cc_library_headers &#123;</span><br><span class="line">    name: <span class="string">&quot;libinfrastructurehal_headers&quot;</span>,</span><br><span class="line">    host_supported: true,</span><br><span class="line">    recovery_available: true,</span><br><span class="line"></span><br><span class="line">    export_include_dirs: [<span class="string">&quot;include&quot;</span>],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="发现报错："><a href="#发现报错：" class="headerlink" title="发现报错："></a>发现报错：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virtual Return&lt;ErrorCode&gt; registerListenerForALM(const ::android::sp&lt;IInfraStructureForALMCallback&gt;&amp; listener);                   ^ vendor/hht/infra/InfraStructureHal/service/impl/InfraStructureHal.h:31:16: note: candidate found by name lookup is &#x27;vendor::hht::infrastructurehal::infrastructurehal::V1_0::ErrorCode&#x27;    enum class ErrorCode;               ^ out/soong/.intermediates/vendor/hht/common/OpenAPIManager/carpowerservice/hidl/carpowerservice/1.0/vendor.hht.carpowerservice.carpowerservice@1.0_genc++_headers/gen/vendor/hht/carpowerservice/carpowerserv ice/1.0/types.h:21:12: note: candidate found by name lookup is &#x27;vendor::hht::carpowerservice::carpowerservice::V1_0::ErrorCode&#x27; enum class ErrorCode : int32_t &#123;           ^ In file included from vendor/hht/infra/InfraStructureHal/service/impl/InfraStructureHal.cpp:10: vendor/hht/infra/InfraStructureHal/service/impl/InfraStructureHal.h:186:20: error: reference to &#x27;ErrorCode&#x27; is ambiguous</span><br></pre></td></tr></table></figure>

<p>很明显这是他不知道代码中的ErrorCode是属于vendor::hht::carpowerservice::carpowerservice::V1_0::ErrorCode还是vendor::hht::infrastructurehal::infrastructurehal::V1_0::ErrorCode</p>
<p>那么使用using指定一下就好了：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> ErrorCode = vendor::hht::infrastructurehal::infrastructurehal::V1_0::ErrorCode;</span><br></pre></td></tr></table></figure>

<h3 id="新启一个服务时有哪些注意事项"><a href="#新启一个服务时有哪些注意事项" class="headerlink" title="新启一个服务时有哪些注意事项"></a>新启一个服务时有哪些注意事项</h3><h4 id="在C-中是不允许你引我的-h，我引你的-h也就是会你依赖我我依赖你"><a href="#在C-中是不允许你引我的-h，我引你的-h也就是会你依赖我我依赖你" class="headerlink" title="在C++中是不允许你引我的.h，我引你的.h也就是会你依赖我我依赖你"></a>在C++中是不允许你引我的.h，我引你的.h也就是会你依赖我我依赖你</h4><p>怎么解决呢？</p>
<p>在这个.h文件中如果我要用到FsemProxyService的实例就会被告知无法找到</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _FSEM_DIAG_STUB_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _FSEM_DIAG_STUB_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;log/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;MData.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;IDiagnosisListener.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;DiagCommunicationManager.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span>  LOG_TAG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_TAG <span class="string">&quot;HFsemDiagStub&quot;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FsemProxyService</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FsemDiagStub</span>: <span class="keyword">public</span> IDiagnosisListener &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">FsemDiagStub</span>(FsemProxyService* service);</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">FsemDiagStub</span>();</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">eolFsemMessageResponse</span><span class="params">(<span class="type">const</span> std::vector&lt;<span class="type">uint8_t</span>&gt; &amp;data)</span></span>;</span><br><span class="line">    <span class="comment">// extends IDiagnosisListener</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onEolMessageRequest</span><span class="params">(std::vector&lt;<span class="type">uint8_t</span>&gt; &amp;data)</span></span>;</span><br><span class="line"><span class="keyword">private</span> :</span><br><span class="line">    DiagCommunicationManager* m_Manager = <span class="literal">nullptr</span>;</span><br><span class="line">    FsemProxyService* m_FsemProxyService = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  <span class="comment">// _FSEM_DIAG_STUB_H_</span></span></span><br></pre></td></tr></table></figure>

<p>那么就声明这个实例，并让FsemProxyService在构造FsemDiagStub的时候把对象通过构造方法传过来这样就可以用到FsemProxyService的对象了，但要记得在</p>
<p>FsemDiagStub.cpp文件中引入FsemProxyService.h</p>
<h4 id="在配置rc文件的时候可能会出现什么问题"><a href="#在配置rc文件的时候可能会出现什么问题" class="headerlink" title="在配置rc文件的时候可能会出现什么问题:"></a>在配置rc文件的时候可能会出现什么问题:</h4><p>service 后面的服务名和路径的服务要正确，否则在打包的时候无法打入到system.img下进而无法在system&#x2F;bin&#x2F;下存在</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">on property:persist.fsemproxyservice.enable=<span class="number">1</span></span><br><span class="line">    start FsemProxyService</span><br><span class="line"></span><br><span class="line">on property:persist.fsemproxyservice.enable=<span class="number">0</span></span><br><span class="line">    stop FsemProxyService</span><br><span class="line"></span><br><span class="line">service FsemProxyService /system/bin/FsemProxyService</span><br><span class="line">   <span class="keyword">class</span> main</span><br><span class="line">   user root</span><br><span class="line">   group root</span><br><span class="line">   disabled</span><br><span class="line">   oneshot</span><br></pre></td></tr></table></figure>

<h1 id="激情GPT"><a href="#激情GPT" class="headerlink" title="激情GPT"></a>激情GPT</h1><p>问题1</p>
<p><code>transDataFun?.invoke(value)</code> 这一行代码的意思可以通过几个部分来解析：</p>
<ol>
<li><p><strong><code>transDataFun</code></strong>：这是一个可能为 <code>null</code> 的函数或方法引用。在 Kotlin 中，函数可以被作为一等公民对象传递和存储。</p>
</li>
<li><p><strong><code>?.</code></strong>：这是 Kotlin 中的安全调用操作符，如果 <code>transDataFun</code> 为 <code>null</code>，那么整个表达式的结果将会是 <code>null</code>，而不会抛出 <code>NullPointerException</code>。</p>
</li>
<li><p><strong><code>invoke(value)</code></strong>：这是调用函数的方法。实际上，<code>invoke</code> 是 Kotlin 的一种特殊操作符，可以用来调用函数对象，等同于 <code>transDataFun(value)</code>。如果 <code>transDataFun</code> 是一个有效的函数引用，<code>invoke(value)</code> 将执行该函数，并传入 <code>value</code> 作为参数。</p>
</li>
</ol>
<p>综上所述，整个表达式的意思是：如果 <code>transDataFun</code> 不为 <code>null</code>，则调用它并将 <code>value</code> 作为参数传递；如果 <code>transDataFun</code> 为 <code>null</code>，则整个表达式的结果为 <code>null</code>。这种写法常用于处理可能为 <code>null</code> 的函数引用，以避免空指针异常。</p>
<p>问题2</p>
<p>代码入下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">override fun &lt;Field&gt; getSomeFieldValue(getEvent: Any): Field? &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isServerConnected()) &#123;</span><br><span class="line">        Logger.d(TAG, <span class="string">&quot;getField server not connected:$&#123;getEvent&#125;&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">val</span> <span class="variable">eventName</span> <span class="operator">=</span> getEvent.javaClass.name</span><br><span class="line">    <span class="type">val</span> <span class="variable">methodGet</span> <span class="operator">=</span> createGetFun(getEvent) ?: <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    <span class="keyword">var</span> ret: Any? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        val getFuture: Future&lt;*&gt;?</span><br><span class="line">        <span class="type">var</span> <span class="variable">fieldCache</span> <span class="operator">=</span> mFieldCache[eventName]</span><br><span class="line">        <span class="comment">//如果是第一次写入，大概是重启adapter或者是上电第一次获取，这时，数据应该不会变，把缓存时间延长到10秒</span></span><br><span class="line">        <span class="type">val</span> <span class="variable">cacheUsefulTime</span> <span class="operator">=</span> <span class="keyword">if</span> (fieldCache?.third == <span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="number">10000</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 第一倍等待时间，第一个获取的去someip等待，第二个时间，用于后续获取的来节约时间</span></span><br><span class="line">            GET_CACHE_TIME</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (System.currentTimeMillis() - (fieldCache?.first ?: <span class="number">0</span>) &lt; cacheUsefulTime) &#123;</span><br><span class="line">            <span class="comment">// 缓存中的FieldFuture处于没获取到的状态</span></span><br><span class="line">            getFuture = fieldCache!!.second</span><br><span class="line">            <span class="title function_">if</span> <span class="params">(!getFuture.isDone)</span> &#123;</span><br><span class="line">                <span class="comment">//因为是单线程，所以上一个都超时了，仍然没有数据，直接返回空</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//没有缓存，或者缓存的future对象超过150ms了,从someIp获取</span></span><br><span class="line">            <span class="type">val</span> <span class="variable">getDataResult</span> <span class="operator">=</span> methodGet.invoke(getEvent)</span><br><span class="line">            <span class="keyword">if</span> (getDataResult == <span class="literal">null</span>) &#123;</span><br><span class="line">                Logger.d(TAG, <span class="string">&quot;getField from someip null,$&#123;eventName&#125;&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (getDataResult is Future&lt;*&gt;) &#123;</span><br><span class="line">                getFuture = getDataResult</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//WTF 根本不可能!</span></span><br><span class="line">                Logger.d(TAG, <span class="string">&quot;getField from someip WTF,$&#123;eventName&#125;&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 中断上一个结果，如果有的话.因为缓存有效时间大于等于future的等待时间，所以这个基本不会影响流程</span></span><br><span class="line">            fieldCache?.second?.cancel(<span class="literal">true</span>)</span><br><span class="line">            <span class="comment">// 存入新的缓存</span></span><br><span class="line">            fieldCache = Triple(System.currentTimeMillis(), getFuture, fieldCache == <span class="literal">null</span>)</span><br><span class="line">            mFieldCache[eventName] = fieldCache</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!getFuture.isDone) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//已等待时间</span></span><br><span class="line">                <span class="type">val</span> <span class="variable">waitGetDoneTime</span> <span class="operator">=</span> System.currentTimeMillis() - fieldCache.first</span><br><span class="line">                Logger.d(TAG, <span class="string">&quot;getField Waiting$&#123;eventName&#125;:$&#123;ret&#125;&quot;</span>)</span><br><span class="line">                ret = <span class="keyword">if</span> (waitGetDoneTime &gt; GET_MAX_WAIT_TIME) &#123;</span><br><span class="line">                    <span class="comment">// 等待过了</span></span><br><span class="line">                    getFuture.get(GET_MIN_WAIT_TIME, TimeUnit.MILLISECONDS)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 等待时间内</span></span><br><span class="line">                    getFuture.get(</span><br><span class="line">                        Math.max(</span><br><span class="line">                            GET_MAX_WAIT_TIME - waitGetDoneTime,</span><br><span class="line">                            GET_MIN_WAIT_TIME</span><br><span class="line">                        ), TimeUnit.MILLISECONDS</span><br><span class="line">                    )</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">                Logger.d(TAG, <span class="string">&quot;getField timeout$&#123;eventName&#125;:$&#123;ret&#125;&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果done了基本是秒出结果</span></span><br><span class="line">            ret = getFuture.get(GET_MIN_WAIT_TIME, TimeUnit.MILLISECONDS)</span><br><span class="line">            Logger.d(TAG, <span class="string">&quot;getField done$&#123;eventName&#125;:$&#123;ret&#125;&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">        <span class="comment">//应该是ret as Field 类型转换错误</span></span><br><span class="line">        Logger.e(SoIpFieldFun.TAG, <span class="string">&quot;getField error:$&#123;eventName&#125;&quot;</span>, e)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">if</span> (ret != <span class="literal">null</span>) ret as Field <span class="keyword">else</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段 Kotlin 代码实现了一个名为 <code>getSomeFieldValue</code> 的泛型函数，该函数主要用于获取某个字段的值。它使用了缓存机制和异步处理，结合了 <code>Future</code> 对象来处理可能的延迟。以下是对代码的逐步解析：</p>
<h3 id="函数签名"><a href="#函数签名" class="headerlink" title="函数签名"></a>函数签名</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;Field&gt;</span> <span class="title">getSomeFieldValue</span><span class="params">(getEvent: <span class="type">Any</span>)</span></span>: Field?</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>泛型 <code>&lt;Field&gt;</code></strong>：表示该函数可以返回任意类型的字段值。</li>
<li><strong>参数 <code>getEvent: Any</code></strong>：传入的事件对象，类型为 <code>Any</code>，可以是任何对象。</li>
</ul>
<h3 id="函数逻辑"><a href="#函数逻辑" class="headerlink" title="函数逻辑"></a>函数逻辑</h3><ol>
<li><p><strong>检查服务器连接</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!isServerConnected()) &#123;</span><br><span class="line">    Logger.d(TAG, <span class="string">&quot;getField server not connected:<span class="subst">$&#123;getEvent&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>首先检查服务器是否连接，如果未连接，记录日志并返回 <code>null</code>。</li>
</ul>
</li>
<li><p><strong>获取事件名称和方法引用</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> eventName = getEvent.javaClass.name</span><br><span class="line"><span class="keyword">val</span> methodGet = createGetFun(getEvent) ?: <span class="keyword">return</span> <span class="literal">null</span></span><br></pre></td></tr></table></figure>
<ul>
<li>获取事件的类名，并通过 <code>createGetFun</code> 方法获取一个用于获取字段值的方法引用。如果获取失败，返回 <code>null</code>。</li>
</ul>
</li>
<li><p><strong>初始化变量</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ret: Any? = <span class="literal">null</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>ret</code> 用于存储最终获取的字段值。</li>
</ul>
</li>
<li><p><strong>获取缓存</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fieldCache = mFieldCache[eventName]</span><br></pre></td></tr></table></figure>
<ul>
<li>从缓存中获取与 <code>eventName</code> 相关的缓存数据。</li>
</ul>
</li>
<li><p><strong>设置缓存有效时间</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> cacheUsefulTime = <span class="keyword">if</span> (fieldCache?.third == <span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="number">10000</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    GET_CACHE_TIME</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>根据缓存状态设置缓存的有效时间。如果是第一次写入，缓存时间延长到 10 秒。</li>
</ul>
</li>
<li><p><strong>检查缓存是否可用</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (System.currentTimeMillis() - (fieldCache?.first ?: <span class="number">0</span>) &lt; cacheUsefulTime) &#123;</span><br><span class="line">    getFuture = fieldCache!!.second</span><br><span class="line">    <span class="keyword">if</span> (!getFuture.isDone) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果缓存仍然有效，获取缓存中的 <code>Future</code> 对象。如果这个 <code>Future</code> 还没有完成，返回 <code>null</code>。</li>
</ul>
</li>
<li><p><strong>获取数据</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> getDataResult = methodGet.invoke(getEvent)</span><br></pre></td></tr></table></figure>
<ul>
<li>如果没有有效的缓存，则通过 <code>methodGet</code> 调用获取数据。</li>
</ul>
</li>
<li><p><strong>处理获取结果</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (getDataResult == <span class="literal">null</span>) &#123;</span><br><span class="line">    Logger.d(TAG, <span class="string">&quot;getField from someip null,<span class="subst">$&#123;eventName&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果获取结果为 <code>null</code>，记录日志并返回 <code>null</code>。</li>
</ul>
</li>
<li><p><strong>处理 <code>Future</code> 对象</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (getDataResult <span class="keyword">is</span> Future&lt;*&gt;) &#123;</span><br><span class="line">    getFuture = getDataResult</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Logger.d(TAG, <span class="string">&quot;getField from someip WTF,<span class="subst">$&#123;eventName&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>检查获取的数据是否为 <code>Future</code> 对象。如果不是，记录日志并返回 <code>null</code>。</li>
</ul>
</li>
<li><p><strong>更新缓存</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fieldCache?.second?.cancel(<span class="literal">true</span>)</span><br><span class="line">fieldCache = Triple(System.currentTimeMillis(), getFuture, fieldCache == <span class="literal">null</span>)</span><br><span class="line">mFieldCache[eventName] = fieldCache</span><br></pre></td></tr></table></figure>
<ul>
<li>如果有旧的 <code>Future</code> 对象，取消它，并更新缓存。</li>
</ul>
</li>
<li><p><strong>等待 <code>Future</code> 完成</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!getFuture.isDone) &#123;</span><br><span class="line">    <span class="comment">// Wait logic</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ret = getFuture.<span class="keyword">get</span>(GET_MIN_WAIT_TIME, TimeUnit.MILLISECONDS)</span><br><span class="line">    Logger.d(TAG, <span class="string">&quot;getField done<span class="subst">$&#123;eventName&#125;</span>:<span class="subst">$&#123;ret&#125;</span>&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果 <code>Future</code> 还未完成，等待它完成并获取结果。如果已经完成，则直接获取结果。</li>
</ul>
</li>
<li><p><strong>异常处理</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">    Logger.e(SoIpFieldFun.TAG, <span class="string">&quot;getField error:<span class="subst">$&#123;eventName&#125;</span>&quot;</span>, e)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>捕获并记录任何异常，可能是类型转换错误等。</li>
</ul>
</li>
<li><p><strong>返回最终结果</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">if</span> (ret != <span class="literal">null</span>) ret <span class="keyword">as</span> Field <span class="keyword">else</span> <span class="literal">null</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果 <code>ret</code> 不为 <code>null</code>，将其转换为 <code>Field</code> 类型并返回；否则返回 <code>null</code>。</li>
</ul>
</li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这段代码的主要目的是通过事件对象获取某个字段的值，使用了缓存机制来提高性能，并通过 <code>Future</code> 对象处理异步操作。代码中包含了详细的日志记录和异常处理，以便于调试和错误追踪。</p>
<h2 id="混淆导致的坑，反射拿不到"><a href="#混淆导致的坑，反射拿不到" class="headerlink" title="混淆导致的坑，反射拿不到"></a>混淆导致的坑，反射拿不到</h2><p>在编程和软件开发中，混淆（Obfuscation）和反射（Reflection）是两个不同的概念。混淆通常是指通过改变代码的结构和命名来使其难以理解，从而保护代码的知识产权或防止逆向工程。而反射是一种在运行时检查和操作对象的能力。</p>
<p>如果代码没有经过混淆，反射可能会更容易进行，因为：</p>
<ol>
<li><strong>可读性</strong>：未混淆的代码通常具有清晰的命名和结构，反射机制可以更容易地识别类、方法和属性。</li>
<li><strong>元数据</strong>：反射依赖于元数据（如类名、方法名等），未混淆的代码保留了这些信息，使得反射操作更为直接。</li>
<li><strong>安全性</strong>：混淆的代码可能会改变类和方法的名称，使得反射无法找到正确的目标，从而导致反射失败。</li>
</ol>
<p>因此，混淆可以增加反射的难度，保护代码的安全性和完整性。</p>
<p>最后看看<strong>Keep标签包名对不对</strong></p>
<h2 id="Kotlin小计"><a href="#Kotlin小计" class="headerlink" title="Kotlin小计"></a>Kotlin小计</h2><p>val a 对应的为final，var b 对应的为非final</p>
<p>Kotlin此设计的原因则是<strong>防止非final的滥用，若一个变量永远不被修改则有必要给其加上final，使其他人看代码时更好理解。</strong></p>
<p>后期我们写代码时则可先使用val，若真的需要修改再改为var</p>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><h4 id="函数的声明"><a href="#函数的声明" class="headerlink" title="函数的声明"></a>函数的声明</h4><h4 id="无参无返回值"><a href="#无参无返回值" class="headerlink" title="无参无返回值"></a>无参无返回值</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="有参有返回值"><a href="#有参有返回值" class="headerlink" title="有参有返回值"></a>有参有返回值</h4><p>参数的类型需要写在形参名后面中间使用:连接多个参数使用,分割”,”返回值使用”:”拼接</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">add</span><span class="params">(a: <span class="type">Int</span>, b: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="声明技巧"><a href="#声明技巧" class="headerlink" title="声明技巧"></a>声明技巧</h4><p>当函数体只有一行代码时可直接使用下面方式声明方法</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">add</span> <span class="params">(a: <span class="type">Int</span>, b: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> = a + b </span><br></pre></td></tr></table></figure>

<p>Kotlin存在<strong>类型推导</strong>,返回值类型也可省略</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">add</span> <span class="params">(a: <span class="type">Int</span>, b: <span class="type">Int</span>)</span></span> = a + b</span><br></pre></td></tr></table></figure>

<h4 id="函数的调用"><a href="#函数的调用" class="headerlink" title="函数的调用"></a>函数的调用</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    test()</span><br><span class="line">    println(add(<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Kotlin直接这么写</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">max</span><span class="params">(a: <span class="type">Int</span>, b: <span class="type">Int</span>)</span></span> = <span class="keyword">if</span> (a &gt; b) a <span class="keyword">else</span> b</span><br></pre></td></tr></table></figure>

<h4 id="when实现"><a href="#when实现" class="headerlink" title="when实现"></a>when实现</h4><p>必须实现else，否则报错</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getScore</span><span class="params">(name: <span class="type">String</span>)</span></span> = <span class="keyword">when</span>(name) &#123;</span><br><span class="line">    <span class="string">&quot;Tom&quot;</span> -&gt; <span class="string">&quot;不及格&quot;</span></span><br><span class="line">    <span class="string">&quot;Jim&quot;</span> -&gt; <span class="string">&quot;及格&quot;</span></span><br><span class="line">    <span class="string">&quot;Pony&quot;</span> -&gt; <span class="string">&quot;良好&quot;</span></span><br><span class="line">    <span class="string">&quot;Tony&quot;</span> -&gt; <span class="string">&quot;优秀&quot;</span></span><br><span class="line">    <span class="keyword">else</span> -&gt; <span class="string">&quot;名字非法&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>when支持参数检查</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">checkNumber</span><span class="params">(num: <span class="type">Number</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">when</span> (num) &#123;</span><br><span class="line">        <span class="keyword">is</span> <span class="built_in">Int</span> -&gt; println(<span class="string">&quot;Int&quot;</span>)</span><br><span class="line">        <span class="keyword">is</span> <span class="built_in">Double</span> -&gt; println(<span class="string">&quot;Double&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span> -&gt; println(<span class="string">&quot;others&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>-&gt;后多行执行</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getScore</span><span class="params">(name: <span class="type">String</span>)</span></span> = <span class="keyword">when</span> &#123;</span><br><span class="line">    <span class="comment">//若name以Tom开头则命中此分支</span></span><br><span class="line">    name.startsWith(<span class="string">&quot;Tom&quot;</span>) -&gt; &#123;</span><br><span class="line">        <span class="comment">//处理</span></span><br><span class="line">        println(<span class="string">&quot;你好，我是Tom开头的同学&quot;</span>)</span><br><span class="line">        <span class="string">&quot;不及格&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    name == <span class="string">&quot;Jim&quot;</span> -&gt; <span class="string">&quot;及格&quot;</span></span><br><span class="line">    name == <span class="string">&quot;Pony&quot;</span> -&gt; <span class="string">&quot;良好&quot;</span></span><br><span class="line">    name == <span class="string">&quot;Tony&quot;</span> -&gt; <span class="string">&quot;优秀&quot;</span></span><br><span class="line">    <span class="keyword">else</span> -&gt; <span class="string">&quot;名字非法&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="类和对象"><a href="#类和对象" class="headerlink" title="类和对象"></a>类和对象</h3><h4 id="创建Person类，并声明name，age，创建printInfo方法"><a href="#创建Person类，并声明name，age，创建printInfo方法" class="headerlink" title="创建Person类，并声明name，age，创建printInfo方法"></a>创建Person类，并声明name，age，创建printInfo方法</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> name = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> age = <span class="number">0</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">printInfo</span><span class="params">()</span></span> &#123;</span><br><span class="line">        println(name +<span class="string">&quot;&#x27;s age is &quot;</span> + age)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="在main方法中声明一个Person对象并调用printInfo方法"><a href="#在main方法中声明一个Person对象并调用printInfo方法" class="headerlink" title="在main方法中声明一个Person对象并调用printInfo方法"></a>在main方法中声明一个Person对象并调用printInfo方法</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> person = Person()</span><br><span class="line">    person.name = <span class="string">&quot;zjm&quot;</span></span><br><span class="line">    person.age = <span class="number">20</span></span><br><span class="line">    person.printInfo()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//结果如下zjm&#x27;s age is 20</span></span><br></pre></td></tr></table></figure>



<h3 id="Gradle可以通过如下方法引用到别的模块相同的业务逻辑代码"><a href="#Gradle可以通过如下方法引用到别的模块相同的业务逻辑代码" class="headerlink" title="Gradle可以通过如下方法引用到别的模块相同的业务逻辑代码"></a>Gradle可以通过如下方法引用到别的模块相同的业务逻辑代码</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    sourceSets &#123;</span><br><span class="line">        main &#123;</span><br><span class="line">            java&#123;</span><br><span class="line">                srcDir(<span class="string">&quot;../HM5/src/main/java/com/seres/adapter/adapters/&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Android系统可以通过如下命令获取版本信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm dump  com.seres.publicadapter | grep version</span><br></pre></td></tr></table></figure>


    </div>

    
        <hr class="fhr">
        <div id="vcomments"></div>
    
</div>
    <div class="footer" id="footer">
    <p>Copyright © 2020 <a class="flink" target="_blank" rel="noopener" href="https://hexo.io">Hexo</a>-<a class="flink" target="_blank" rel="noopener" href="https://github.com/sanjinhub/hexo-theme-geek">Geek</a>.
        <label class="el-switch el-switch-green el-switch-sm" style="vertical-align: sub;">
            <input type="checkbox" name="switch" id="update_style">
            <span class="el-switch-style"></span>
        </label>
<!--         <script type="text/javascript">
        var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");
        document.write(unescape("%3Cspan id='cnzz_stat_icon_1278548644'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/stat.php%3Fid%3D1278548644%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
        </script> -->
    </p>
</div>
<input type="hidden" id="web_style" value="white">
<input type="hidden" id="valine_appid" value="CmCti21ooOOIzFOhEyFkFvR0-gzGzoHsz">
<input type="hidden" id="valine_appKey" value="FqiyUqbg7McKN2eG0MCewupf">

<script src="/libs/jquery.min.js"></script>


<script src="/libs/highlight/highlight.pack.js"></script>

<script src='//cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>

<script src="/js/js.js"></script>

<style type="text/css">
.v * {
    color: #698fca;
}

.v .vlist .vcard .vhead .vsys {
    color: #3a3e4a;
}

.v .vlist .vcard .vh .vmeta .vat {
    color: #638fd5;
}

.v .vlist .vcard .vhead .vnick {
    color: #6ba1ff;
}

.v a {
    color: #8696b1;
}

.v .vlist .vcard .vhead .vnick:hover {
    color: #669bfc;
}
</style>
</body>

</html>